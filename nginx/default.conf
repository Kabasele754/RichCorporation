# =========================
# UPSTREAMS (Docker network)
# =========================
upstream django {
    server django:8000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}
upstream pgadmin_up {
    server pgadmin:80;
    keepalive 16;
}

# =========================
# HTTP -> HTTPS (sauf ACME)
# =========================
server {
  listen 80;
  listen [::]:80;
  server_name richcorporationsa.com www.richcorporationsa.com api.richcorporationsa.com pgadmin.richcorporationsa.com;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
  }

  return 301 https://$host$request_uri;
}

# =========================
# HTTPS: visocarte.com + www
# =========================
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name richcorporationsa.com www.richcorporationsa.com;

  ssl_certificate     /etc/letsencrypt/live/richcorporationsa.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/richcorporationsa.com/privkey.pem;

  # ---- Upload limits / timeouts (fix 413)
  client_max_body_size 12m;
  client_body_timeout 60s;
  send_timeout 60s;

  # ---- Buffers
  proxy_request_buffering on;
  proxy_buffering on;
  proxy_buffers 32 32k;
  proxy_busy_buffers_size 256k;
  proxy_buffer_size 64k;

  # ---- Timeouts & keepalive
  proxy_connect_timeout 60s;
  proxy_send_timeout 60s;
  proxy_read_timeout 120s;
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  # ---- Common proxy headers
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_set_header X-Forwarded-Port  443;

  # ACME
  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
  }

  location /static/ { 
    alias /app/static/;
     expires 1M; 
     access_log off; 
     add_header Cache-Control "public"; 
     }
location /media/  { 
  alias /app/media/;  
  expires 1M; 
  access_log off; 
  add_header Cache-Control "public"; 
  }

  # WebSockets (sans `map`)
  location /ws/ {
    proxy_pass http://django;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 120s;
  }

  # App Django
  location / {
    proxy_pass http://django;
  }

}
  


# =========================
# HTTPS: api.visocarte.com
# =========================
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name api.richcorporationsa.com;

  ssl_certificate     /etc/letsencrypt/live/richcorporationsa.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/richcorporationsa.com/privkey.pem;

  client_max_body_size 12m;
  client_body_timeout 60s;
  proxy_connect_timeout 60s;
  proxy_send_timeout 60s;
  proxy_read_timeout 120s;
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_set_header X-Forwarded-Port  443;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
  }

  location / {
    proxy_pass http://django;
  }
}

# =========================
# HTTPS: pgadmin.visocarte.com
# =========================
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name pgadmin.richcorporationsa.com;

  ssl_certificate     /etc/letsencrypt/live/richcorporationsa.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/richcorporationsa.com/privkey.pem;

  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto https;

  location / {
    proxy_pass http://pgadmin_up;
  }

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
  }
}
