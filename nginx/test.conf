; # Définition des upstreams
; upstream django {
;     server django:8000;
; }
;
; upstream pgadmin {
;     server pgadmin:80;
; }
;
; # Configuration du serveur HTTP (redirection vers HTTPS)
; server {
;     listen 80;
;     server_name visocarte.com  www.visocarte.com;
;
;     location /.well-known/acme-challenge/ {
;         root /var/www/certbot;
;         try_files $uri =404;
;     }
;
;     location / {
;         return 301 https://$host$request_uri;
;     }
; }
;
; # Configuration du serveur HTTPS principal
; server {
;     listen 443 ssl;
;     server_name visocarte.com  www.visocarte.com ;
;
;     autoindex off;  # Désactive l'affichage des index des répertoires
;     server_tokens off;  # Masque la version de Nginx dans les en-têtes HTTP
;
;
;     # Configuration SSL
;     ssl_certificate /etc/letsencrypt/live/visocarte.com/fullchain.pem;
;     ssl_certificate_key /etc/letsencrypt/live/visocarte.com/privkey.pem;
;
;     # Configuration SSL/TLS améliorée
;     ssl_protocols TLSv1.2 TLSv1.3;
;     ssl_prefer_server_ciphers off;
;     # ssl_prefer_server_ciphers on;
;     ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
;     ssl_session_timeout 1d;
;     ssl_session_cache shared:MozSSL:10m;
;     ssl_session_tickets off;
;
;
;     # ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
;
;     ssl_stapling on;
;     ssl_stapling_verify on;
;     resolver 8.8.8.8 8.8.4.4 valid=300s;
;     resolver_timeout 5s;
;
;     ssl_dhparam /etc/nginx/dhparam.pem;
;
;     # En-têtes de sécurité HTTP
;     add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always; # HSTS
;     add_header X-Frame-Options "DENY" always; # Protection contre le Clickjacking
;     add_header X-Content-Type-Options "nosniff" always; # Empêche l'interprétation des types MIME
;     add_header X-XSS-Protection "1; mode=block" always; # Protection contre le XSS
;     add_header Referrer-Policy "no-referrer-when-downgrade" always; # Contrôle des informations de référence
;     add_header Permissions-Policy "geolocation=(self), microphone=()" always; # Contrôle des API autorisées
;     add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; frame-ancestors 'none'; base-uri 'self';" always; # CSP
;
;     # Optimisation des performances
;     gzip on;
;     gzip_vary on;
;     gzip_proxied any;
;     gzip_comp_level 6;
;     gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
;
;     # Gestion des éléments statiques
;     location = /favicon.ico { access_log off; log_not_found off; }
;     location /static {
;         alias /app/static/;
;         expires 1M;
;         access_log off;
;         add_header Cache-Control "public";
;     }
;
;     location /media {
;         alias /app/media/;
;         expires 1M;
;         access_log off;
;         add_header Cache-Control "public";
;     }
;
;     # Configuration du proxy vers l'application Django
;     location / {
;         proxy_pass http://django;
;         proxy_set_header Host $host;
;         proxy_set_header X-Real-IP $remote_addr;
;         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
;         proxy_set_header X-Forwarded-Proto $scheme;
;         proxy_read_timeout 180s;
;         proxy_send_timeout 180s;
;
;         client_max_body_size 50M;
;
;         # Configuration CORS
;         if ($request_method = 'OPTIONS') {
;             add_header 'Access-Control-Allow-Origin' 'https://visocarte.com';
;             add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
;             add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
;             add_header 'Access-Control-Max-Age' 1728000;
;             add_header 'Content-Type' 'text/plain; charset=utf-8';
;             add_header 'Content-Length' 0;
;             return 204;
;         }
;
;         add_header 'Access-Control-Allow-Origin' 'https://visocarte.com' always;
;         add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
;         add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
;         add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
;         add_header 'Access-Control-Allow-Credentials' 'true' always;
;     }
;
;     # Configuration du proxy pour WebSocket
;     location /ws/ {
;         proxy_pass http://django;
;         proxy_http_version 1.1;
;         proxy_set_header Upgrade $http_upgrade;
;         proxy_set_header Connection "upgrade";
;         proxy_set_header Host $host;
;         proxy_read_timeout 3600s;
;         proxy_send_timeout 3600s;
;         proxy_buffering off;  # Désactiver la mise en tampon pour les WebSockets
;         proxy_buffers 8 16k;
;         proxy_buffer_size 32k;
;
;         # Configurer CORS pour WebSockets
;         add_header 'Access-Control-Allow-Origin' 'https://visocarte.com' always;
;         add_header 'Access-Control-Allow-Credentials' 'true' always;
;     }
;
; }
;
; # Configuration du serveur HTTPS pour pgAdmin
; server {
;     listen 443 ssl;
;     server_name pgadmin.trustmysecurity.com;
;
;     # Certificats SSL/TLS
;     ssl_certificate /etc/letsencrypt/live/visocarte.comfullchain.pem;
;     ssl_certificate_key /etc/letsencrypt/live/visocarte.com/privkey.pem;
;
;     # Configuration SSL/TLS améliorée
;     ssl_protocols TLSv1.2 TLSv1.3;
;     ssl_prefer_server_ciphers off;
;     ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
;     ssl_session_timeout 1d;
;     ssl_session_cache shared:MozSSL:10m;
;     ssl_session_tickets off;
;
;     ssl_stapling on;
;     ssl_stapling_verify on;
;     resolver 8.8.8.8 8.8.4.4 valid=300s;
;     resolver_timeout 5s;
;
;     ssl_dhparam /etc/nginx/dhparam.pem;
;
;     # Sécurité renforcée pour pgAdmin
;     add_header Strict-Transport-Security "max-age=63072000" always;
;     add_header X-Frame-Options DENY;
;     add_header X-Content-Type-Options nosniff;
;
;     location / {
;         auth_basic "Restricted Access";
;         auth_basic_user_file /etc/nginx/.htpasswd;
;
;         proxy_pass http://pgadmin;
;         proxy_set_header Host $host;
;         proxy_set_header X-Real-IP $remote_addr;
;         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
;         proxy_set_header X-Forwarded-Proto $scheme;
;     }
;
;     # Limiter les méthodes HTTP autorisées
;     if ($request_method !~ ^(GET|HEAD|POST)$) {
;         return 444;
;     }
;
;     # Bloquer l'accès aux fichiers sensibles
;     location ~ /\.(?!well-known) {
;         deny all;
;     }
; }
;
; # Sécurité supplémentaire globale
; client_max_body_size 50M;
; client_body_timeout 10s;
; client_header_timeout 10s;
; server_tokens off;
;
; # Limitation de la connexion et des requêtes
; limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
; limit_conn conn_limit_per_ip 10;
;
; limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=5r/s;
; limit_req zone=req_limit_per_ip burst=10 nodelay;


upstream django { server viso_app:8000; }
upstream pgadmin_up { server pgadmin:80; }

server {
  listen 80;
  listen [::]:80;
  server_name visocarte.com www.visocarte.com;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
  }

  location /static/ { alias /app/static/;  expires 1M; access_log off; add_header Cache-Control "public"; }
  location /media/  { alias /app/media/;   expires 1M; access_log off; add_header Cache-Control "public"; }

  location / {
    proxy_pass http://django;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto http;
  }
}

server {
  listen 80;
  listen [::]:80;
  server_name api.visocarte.com;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
  }

  location / {
    proxy_pass http://django; # ou autre service si api séparée
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto http;
  }
}

server {
  listen 80;
  listen [::]:80;
  server_name pgadmin.visocarte.com;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
  }

  location / {
    proxy_pass http://pgadmin_up;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto http;
  }
}
